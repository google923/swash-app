<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0078d7" />
  <title>User Management - Swash Admin</title>
  <link rel="manifest" href="../manifest.json" />
  <link rel="icon" href="../assets/favicon-192.png" type="image/png" />
  <link rel="stylesheet" href="../style.css" />
  <style>
    .user-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .user-card {
      padding: 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
    }
    .user-card__header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }
    .user-card__name {
      font-weight: 700;
      color: #0078d7;
      font-size: 1.1rem;
    }
    .user-card__role {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .user-card__role--admin {
      background: #dbeafe;
      color: #1e40af;
    }
    .user-card__role--rep {
      background: #dcfce7;
      color: #166534;
    }
    .user-card__role--cleaner {
      background: #dcfce7;
      color: #166534;
    }
    .user-card__role--subscriber {
      background: #faf5ff;
      color: #6b21a8;
    }
    .user-card__info {
      font-size: 0.9rem;
      color: #64748b;
      margin-bottom: 8px;
    }
    .user-card__actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .user-card__training {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
      font-size: 0.9rem;
    }
    .user-card__disabled {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
      font-size: 0.9rem;
    }
    .disabled-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 8px;
      background: #fee2e2;
      color: #991b1b;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .user-card__contract-type {
      margin-top: 8px;
      padding: 8px;
      background: #f0f9ff;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .user-card__contract-type label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #1e293b;
    }
    .user-card__contract-type select {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .training-toggle {
      width: 48px;
      height: 24px;
      position: relative;
      display: inline-block;
    }
    .training-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .training-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e1;
      transition: .3s;
      border-radius: 24px;
    }
    .training-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    .training-toggle input:checked + .training-slider {
      background-color: #0078d7;
    }
    .training-toggle input:checked + .training-slider:before {
      transform: translateX(24px);
    }
    .training-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 8px;
      background: #fef3c7;
      color: #92400e;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    /* Centered Edit Modal */
    #editModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.45);
      z-index: 80;
      padding: 20px;
    }

    #editModal:not([hidden]) { display: flex; }

    #editModal .modal__dialog {
      background: #fff;
      padding: 24px;
      border-radius: 16px;
      width: min(520px, 95vw);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
    }

    /* Small icon buttons (e.g., delete X) */
    .icon-btn {
      width: 28px;
      height: 28px;
      min-width: 28px;
      min-height: 28px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: #dc2626;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .icon-btn:hover { background: #fee2e2; }
    .icon-btn:focus { outline: 2px solid #fecaca; outline-offset: 2px; }

    .user-card__header-right{ display:flex; align-items:center; gap:8px; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <img class="header-logo" src="../assets/swash-icon-white.png" alt="Swash logo" />
    </div>
    <div class="header-actions">
      <button id="logoutBtn" class="btn btn-secondary" type="button">Sign out</button>
      <div class="menu-box">
        <button id="menuBtn" class="btn btn-secondary" aria-haspopup="true" aria-expanded="false">Menu</button>
        <nav id="menuDropdown" class="dropdown">
          <div class="dropdown-title">Navigation</div>
          <a href="/admin/dashboard.html" class="admin-only">üè† Admin Overview</a>
          <a href="/pipeline.html" class="admin-only">üìã New Customer Pipeline</a>
          <a href="/rep/add-new-customer.html">üÜï New Quote</a>
          <a href="/rep/scheduler.html" class="admin-rep">üìÖ Schedule</a>
          <a href="/admin/subscribers.html" class="admin-only">üè¢ Subscribers</a>
          <a href="./users.html" class="admin-only">üë• Manage Users</a>
          <a href="./stats.html" class="admin-only">üìä Stats</a>
          <a href="/admin-tracking.html" class="admin-only">üõ∞Ô∏è Rep Tracking</a>
          <a href="./shifts-logs.html" class="admin-only">üìã Shifts & Logs</a>
          <a href="./message-log.html" class="admin-only">üìß Message Log</a>
          <a href="/rep/rep-home.html" class="rep-only">üè† Rep Home</a>
          <a href="/subscriber-dashboard.html" class="subscriber-only">üè† Dashboard</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="page">
    <section class="card">
      <header class="card-header">
        <h1>üë• User Management</h1>
        <p class="text-muted">Add new reps, update user details, and manage access permissions.</p>
      </header>

      <div style="padding: 20px;">
        <h3 style="color: #0078d7; margin-bottom: 16px;">Add New Rep</h3>
        <form id="addUserForm">
          <div class="form-row">
            <label style="display: block;">
              <span style="display: block; margin-bottom: 4px; font-weight: 600;">Email *</span>
              <input type="email" id="newEmail" required style="width: 100%; padding: 8px; border: 1px solid #c8d4e5; border-radius: 6px;" placeholder="rep@swashcleaning.co.uk" />
            </label>
            <label style="display: block;">
              <span style="display: block; margin-bottom: 4px; font-weight: 600;">Password *</span>
              <input type="password" id="newPassword" required minlength="6" style="width: 100%; padding: 8px; border: 1px solid #c8d4e5; border-radius: 6px;" placeholder="Minimum 6 characters" />
            </label>
          </div>
          <div class="form-row">
            <label style="display: block;">
              <span style="display: block; margin-bottom: 4px; font-weight: 600;">Username *</span>
              <input type="text" id="newName" required style="width: 100%; padding: 8px; border: 1px solid #c8d4e5; border-radius: 6px;" placeholder="e.g., Chris, Glen, Harvie" />
            </label>
            <label style="display: block;">
              <span style="display: block; margin-bottom: 4px; font-weight: 600;">Company Name (for subscribers)</span>
              <input type="text" id="newCompanyName" style="width: 100%; padding: 8px; border: 1px solid #c8d4e5; border-radius: 6px;" placeholder="Company Ltd" />
            </label>
          </div>
          <div class="form-row">
            <label style="display: block;">
              <span style="display: block; margin-bottom: 4px; font-weight: 600;">Role *</span>
              <select id="newRole" required style="width: 100%; padding: 8px; border: 1px solid #c8d4e5; border-radius: 6px;">
                <option value="rep">Rep</option>
                <option value="admin">Admin</option>
                <option value="subscriber">Subscriber</option>
              </select>
            </label>
          </div>
          <button type="submit" class="btn btn-primary">Create User</button>
        </form>

        <hr style="margin: 32px 0; border: none; border-top: 1px solid #e5e7eb;" />

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h3 style="color: #0078d7; margin: 0;">Current Users</h3>
          <button id="refreshBtn" class="btn btn-secondary">Refresh</button>
        </div>
        
        <div id="usersContainer" class="user-grid">
          <p style="color: #64748b; text-align: center; padding: 40px;">Loading users...</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Edit User Modal -->
  <div id="editModal" class="modal" hidden>
    <div class="modal__dialog">
      <h3 style="margin:0">Edit User</h3>
      <form id="editUserForm">
        <input type="hidden" id="editUserId" />
        <label class="modal__field">
          <span>Username</span>
          <input type="text" id="editName" required />
        </label>
        <label class="modal__field">
          <span>Email</span>
          <input type="email" id="editEmail" disabled style="background: #f9fafb; cursor: not-allowed;" />
          <small style="color: #64748b;">Email cannot be changed after creation</small>
        </label>
        <label class="modal__field">
          <span>Role</span>
          <select id="editRole" required>
            <option value="rep">Rep</option>
            <option value="admin">Admin</option>
            <option value="subscriber">Subscriber</option>
          </select>
        </label>
        <div class="modal__actions">
          <button type="button" class="btn btn-secondary" id="cancelEdit">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module" src="../auth-check.js"></script>
  <script type="module" src="./users.js"></script>
</body>
</html>
