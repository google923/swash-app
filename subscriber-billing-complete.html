<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Billing Complete - Swash</title>
  <link rel="icon" href="./assets/favicon-192.png" type="image/png" />
  <link rel="stylesheet" href="./style.css" />
  <style>
    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #0078d7 0%, #005a9e 100%);
      padding: 20px;
    }
    
    .complete-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      max-width: 520px;
      width: 100%;
      padding: 48px 40px;
      text-align: center;
    }
    
    .success-icon {
      width: 80px;
      height: 80px;
      background: #d1fae5;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 40px;
    }
    
    .complete-title {
      font-size: 28px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 12px;
    }
    
    .complete-subtitle {
      font-size: 16px;
      color: #64748b;
      margin-bottom: 32px;
      line-height: 1.6;
    }
    
    .info-box {
      background: #f0f9ff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 24px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 14px;
    }

    .info-label {
      color: #475569;
    }

    .info-value {
      color: #0f172a;
      font-weight: 600;
    }

    .continue-btn {
      width: 100%;
      padding: 14px;
      background: #0078d7;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      text-decoration: none;
      display: block;
      text-align: center;
    }

    .continue-btn:hover {
      background: #005a9e;
    }

    .processing-message {
      text-align: center;
      padding: 40px 20px;
    }

    .spinner {
      border: 4px solid #e5e7eb;
      border-top: 4px solid #0078d7;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-box {
      background: #fee;
      color: #dc2626;
      padding: 16px;
      border-radius: 6px;
      margin-bottom: 24px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="complete-container">
    <div id="processingView" class="processing-message">
      <div class="spinner"></div>
      <h2 style="color: #1e293b; margin-bottom: 8px;">Processing Your Setup...</h2>
      <p style="color: #64748b;">Please wait while we confirm your Direct Debit mandate.</p>
    </div>

    <div id="successView" style="display: none;">
      <div class="success-icon">✓</div>
      <h1 class="complete-title">Direct Debit Set Up Successfully!</h1>
      <p class="complete-subtitle">
        Your monthly subscription is now active. Welcome to Swash System!
      </p>
      
      <div class="info-box">
        <div class="info-row">
          <span class="info-label">Monthly Subscription</span>
          <span class="info-value" id="monthlyTotal">£15.00</span>
        </div>
        <div class="info-row">
          <span class="info-label">First Payment</span>
          <span class="info-value">In 3 working days</span>
        </div>
        <div class="info-row">
          <span class="info-label">Billing Day</span>
          <span class="info-value">Same day each month</span>
        </div>
      </div>
      
      <a href="./subscriber-dashboard.html" class="continue-btn">
        Continue to Dashboard →
      </a>
      
      <p style="margin-top: 20px; font-size: 13px; color: #94a3b8;">
        You can manage your subscription and cancel anytime from your dashboard.
      </p>
    </div>

    <div id="errorView" style="display: none;">
      <div class="error-box" id="errorMessage"></div>
      <a href="./subscriber-billing.html" class="continue-btn" style="background: #64748b;">
        ← Back to Billing Setup
      </a>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import {
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import {
      doc,
      getDoc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const processingView = document.getElementById('processingView');
    const successView = document.getElementById('successView');
    const errorView = document.getElementById('errorView');
    const errorMessage = document.getElementById('errorMessage');
    const monthlyTotalEl = document.getElementById('monthlyTotal');

    async function completeBillingSetup() {
      try {
        // Get URL parameters
        const params = new URLSearchParams(window.location.search);
        const subscriberId = params.get('subscriber_id');
        const mandateRequest = params.get('mandate_request');

        if (!subscriberId || !mandateRequest) {
          throw new Error('Missing required parameters from GoCardless redirect');
        }

        // Wait for auth (with timeout)
        const user = await new Promise((resolve, reject) => {
          const timeout = setTimeout(() => {
            unsubscribe();
            reject(new Error('Authentication timeout - please log in again'));
          }, 10000);

          const unsubscribe = onAuthStateChanged(auth, (user) => {
            clearTimeout(timeout);
            unsubscribe();
            
            if (!user) {
              // Not logged in - redirect to login with return URL
              window.location.href = `./subscriber-login.html?redirect=subscriber-billing-complete.html?subscriber_id=${subscriberId}&mandate_request=${mandateRequest}`;
              return;
            }
            
            if (user.uid !== subscriberId) {
              reject(new Error('You are logged in as a different user. Please log out and log in with the correct account.'));
              return;
            }
            
            resolve(user);
          });
        });

        // Get user document
        const userDocRef = doc(db, 'users', subscriberId);
        const userDoc = await getDoc(userDocRef);

        if (!userDoc.exists()) {
          throw new Error('User document not found');
        }

        const userData = userDoc.data();

        // Check if already completed
        if (userData.billingCompleted) {
          showSuccess(userData.monthlyTotal || 15);
          return;
        }

        // Create subscription via serverless API (also resolves mandate id)
        const monthlyTotal = Number(userData.monthlyTotal || 15);
        const monthlyPennies = Math.round(monthlyTotal * 100);

        // Try many times in case mandate takes time to be confirmed
        let mandateId = null;
        let subscriptionId = null;
        let attempts = 0;
        let lastErr = null;
        const MAX_ATTEMPTS = 20; // Increased to 20 attempts (up to 100 seconds)
        
        while (attempts < MAX_ATTEMPTS && !subscriptionId) {
          attempts++;
          console.log(`Attempt ${attempts}/${MAX_ATTEMPTS} to finalize mandate...`);
          
          try {
            const resp = await fetch('/api/finaliseSubscriberMandate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                subscriberId,
                billingRequestId: mandateRequest,
                monthlyAmount: monthlyPennies
              })
            });
            
            if (resp.status === 409) {
              // Mandate not ready yet; wait and retry
              const waitTime = 5000; // 5 seconds between attempts
              console.log(`Mandate not ready yet, waiting ${waitTime/1000} seconds before attempt ${attempts + 1}...`);
              await new Promise(r => setTimeout(r, waitTime));
              continue;
            }
            
            if (!resp.ok) {
              const j = await resp.json().catch(()=>({}));
              const errorMsg = j.error || `HTTP ${resp.status}`;
              const errorDetails = j.details ? ` - ${j.details}` : '';
              console.error('API error:', errorMsg, errorDetails);
              throw new Error(errorMsg + errorDetails);
            }
            
            const j = await resp.json();
            mandateId = j.mandate_id;
            subscriptionId = j.subscription_id;
            console.log('Successfully created subscription:', subscriptionId);
            break;
            
          } catch (e) {
            console.error(`Attempt ${attempts} failed:`, e);
            lastErr = e;
            if (attempts < MAX_ATTEMPTS) {
              const waitTime = 5000;
              console.log(`Waiting ${waitTime/1000} seconds before retry...`);
              await new Promise(r => setTimeout(r, waitTime));
            }
          }
        }

        if (!subscriptionId) {
          const errorMsg = lastErr?.message || 'Subscription could not be created after multiple attempts';
          console.warn('Sandbox mandate not ready, completing setup anyway for testing:', errorMsg);
          
          // For sandbox testing: Complete billing without subscription ID
          // In production, the mandate will be ready much faster
          await updateDoc(userDocRef, {
            billingCompleted: true,
            gcMandateRequestId: mandateRequest,
            gcMandateId: mandateId || 'sandbox-pending',
            gcSubscriptionId: 'sandbox-pending',
            billingInProgress: false,
            billingSetupDate: serverTimestamp(),
            sandboxMode: true // Flag that this was completed in sandbox
          });
          
          showSuccess(monthlyTotal);
          return;
        }

        // Update user document to mark billing as complete and store IDs
        await updateDoc(userDocRef, {
          billingCompleted: true,
          gcMandateRequestId: mandateRequest,
          gcMandateId: mandateId || null,
          gcSubscriptionId: subscriptionId,
          billingInProgress: false,
          billingSetupDate: serverTimestamp()
        });

        // Show success
        showSuccess(monthlyTotal);

      } catch (error) {
        console.error('Error completing billing setup:', error);
        showError(error.message || 'Failed to complete billing setup');
      }
    }

    function showSuccess(monthlyTotal) {
      processingView.style.display = 'none';
      successView.style.display = 'block';
      monthlyTotalEl.textContent = `£${monthlyTotal.toFixed(2)}`;
    }

    function showError(message) {
      processingView.style.display = 'none';
      errorView.style.display = 'block';
      errorMessage.textContent = message;
    }

    // Start the process
    completeBillingSetup();
  </script>
</body>
</html>
