<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0078d7" />
  <title>Policy Handbook - Swash Cleaning Ltd</title>
  <link rel="manifest" href="../manifest.json" />
  <link rel="icon" href="../assets/favicon-192.png" type="image/png" />
  <link rel="stylesheet" href="../style.css" />
  <style>
    .policy-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: white;
    }
    .policy-header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 3px solid #0078d7;
    }
    .policy-header h1 {
      color: #0078d7;
      font-size: 2rem;
      margin: 0 0 8px 0;
    }
    .policy-header .subtitle {
      color: #64748b;
      font-size: 1.1rem;
      margin: 8px 0;
    }
    .policy-header .contact-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
      font-size: 0.95rem;
      color: #475569;
    }
    .contact-item {
      display: flex;
      flex-direction: column;
    }
    .contact-item strong {
      color: #0078d7;
    }
    .director-message {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-left: 4px solid #0078d7;
      padding: 24px;
      border-radius: 8px;
      margin: 30px 0;
      font-style: italic;
    }
    .director-message p {
      margin: 12px 0;
      line-height: 1.8;
      color: #1e293b;
    }
    .director-signature {
      text-align: right;
      margin-top: 20px;
      font-style: normal;
      font-weight: 600;
      color: #1e293b;
    }
    .contents {
      background: #f8fafc;
      padding: 20px;
      border-radius: 8px;
      margin: 30px 0;
    }
    .contents h2 {
      color: #0078d7;
      margin-top: 0;
    }
    .contents ul {
      columns: 2;
      column-gap: 30px;
      line-height: 2;
      list-style: none;
      padding: 0;
    }
    .contents li {
      margin-bottom: 8px;
    }
    .policy-section {
      margin: 40px 0;
      page-break-inside: avoid;
    }
    .policy-section h2 {
      color: #0078d7;
      font-size: 1.4rem;
      margin: 0 0 16px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }
    .policy-section h3 {
      color: #1e293b;
      font-size: 1.1rem;
      margin: 16px 0 8px 0;
    }
    .policy-section p {
      line-height: 1.7;
      color: #475569;
      margin: 12px 0;
    }
    .policy-section ul, .policy-section ol {
      line-height: 1.8;
      color: #475569;
      margin: 12px 0 12px 20px;
    }
    .policy-section li {
      margin: 8px 0;
    }
    .policy-table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
    }
    .policy-table th {
      background: #0078d7;
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 600;
    }
    .policy-table td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    .policy-table tr:hover {
      background: #f8fafc;
    }
    .highlight-box {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 16px;
      border-radius: 4px;
      margin: 16px 0;
    }
    .footer-text {
      text-align: center;
      color: #64748b;
      font-size: 0.9rem;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }
    .back-button {
      display: inline-block;
      margin-bottom: 20px;
    }
    @media print {
      body { background: white; }
      .policy-container { max-width: 100%; padding: 0; }
    }
  </style>
</head>
<body>
  <main class="page">
    <div class="policy-container">
      <!-- Header with Logo -->
      <div class="policy-header">
        <div style="margin-bottom: 24px;">
          <img 
            src="../assets/blue-logo.png" 
            alt="Swash Cleaning Ltd Logo" 
            style="height: 80px; object-fit: contain;"
          >
        </div>
        <h1>⭐ Swash Cleaning Ltd</h1>
        <p class="subtitle">Field Sales Team Policy Handbook (Version 1.8 – Commission-Only Contractors)</p>
        <div class="contact-info">
          <div class="contact-item">
            <strong>Registered Address</strong>
            71–75 Shelton Street, London, WC2H 9JQ
          </div>
          <div class="contact-item">
            <strong>Email</strong>
            contact@swashcleaning.co.uk
          </div>
          <div class="contact-item">
            <strong>Telephone</strong>
            03300 436 345
          </div>
          <div class="contact-item">
            <strong>Director</strong>
            Christopher Wessell
          </div>
        </div>
      </div>

      <!-- Director Message -->
      <div class="director-message">
        <h2 style="margin-top: 0; color: #0078d7;">Welcome Message from the Director</h2>
        <p>Welcome to Swash Cleaning Ltd.
        We’re pleased to have you join our team of commission-only freelance field sales representatives.</p>

        <p>At Swash, every conversation you have at the door builds the brand, strengthens our reputation, and helps create long-term customers for our service teams. This handbook explains:</p>

        <ul style="margin: 12px 0 0 20px; color: #1e293b;">
          <li>what is expected of you as a self-employed contractor</li>
          <li>how our systems work</li>
          <li>how commission is earned</li>
          <li>the standards required to represent Swash Cleaning professionally</li>
        </ul>

        <p>Please read this handbook carefully. It forms part of your agreement with Swash Cleaning Ltd as an independent contractor.</p>

        <p>Thank you for being part of the Swash team.</p>

        <div class="director-signature">
          Christopher Wessell<br>
          Director, Swash Cleaning Ltd
        </div>
      </div>

      <!-- Contents -->
      <div class="contents">
        <h2>⭐ Contents</h2>
        <ul>
          <li>Status of Engagement</li>
          <li>Territory Assignment Policy</li>
          <li>Commission & Payment Policy</li>
          <li>Verification Rules</li>
          <li>Conduct & Customer Interaction</li>
          <li>Data Protection & Confidentiality</li>
          <li>Uniform & Appearance</li>
          <li>Health & Safety & Lone Working</li>
          <li>Equal Opportunities</li>
          <li>Non-Compete & Post-Contract Conduct</li>
          <li>Social Media & Brand Representation</li>
          <li>Technology & App Usage</li>
          <li>Vehicle & Driving Requirements</li>
          <li>Policy Acknowledgement</li>
        </ul>
      </div>

      <!-- Section 1 -->
      <div class="policy-section">
        <h2>1. Status of Engagement</h2>
        <p>You are engaged as a self-employed, commission-only contractor.
        You are not an employee of Swash Cleaning Ltd.</p>
        <p>Therefore:</p>
        <ul>
          <li>No hourly pay</li>
          <li>No holiday pay</li>
          <li>No sick pay</li>
          <li>No statutory redundancy</li>
          <li>No employment benefits</li>
          <li>You choose your own hours and working methods</li>
          <li>You are responsible for your own tax, NI, insurance, and expenses</li>
        </ul>
        <p>Swash Cleaning Ltd does not control your schedule, only the territory in which you may operate and the criteria required for commission.</p>
      </div>

      <!-- Section 2 -->
      <div class="policy-section">
        <h2>2. Territory Assignment Policy</h2>
        <p>To avoid overlap and maintain scheduling efficiency:</p>
        <ul>
          <li>Contractors are assigned specific sales territories (streets, mapped zones, towns, or postcodes).</li>
          <li>You may only canvass within the areas assigned to you.</li>
          <li>Signups outside your assigned territory may be rejected and will not qualify for commission.</li>
          <li>Territories may be rotated or changed depending on company requirements.</li>
          <li>Territory assignment is non-exclusive; other contractors may work in nearby areas.</li>
        </ul>
        <p>Territory rules ensure efficient scheduling and route-building. They do not dictate when or how you work.</p>
      </div>

      <!-- Section 3 -->
      <div class="policy-section">
        <h2>3. Commission & Payment Policy (Updated to £15 → £8 → £8 Model)</h2>
        <h3>3.1 Commission-Only Structure</h3>
        <ul>
          <li>You are paid solely by commission on verified customers.</li>
          <li>There is no base pay, no hourly rate, and no expense reimbursement.</li>
        </ul>
        <h3>3.2 Commission Rates (3-Month Taper Model)</h3>
        <p>For every verified customer you sign:</p>
        <ul>
          <li><strong>1st clean completed:</strong> ➡️ £15 commission</li>
          <li><strong>2nd clean completed:</strong> ➡️ £8 commission</li>
          <li><strong>3rd clean completed:</strong> ➡️ £8 commission</li>
          <li><strong>After the 3rd clean:</strong> ➡️ £0 commission — all long-term revenue belongs fully to the Company.</li>
        </ul>
        <h3>3.3 Monthly Payout</h3>
        <p>Commission is paid monthly in arrears. You are paid only for cleans that:</p>
        <ul>
          <li>have been completed</li>
          <li>have been paid by the customer</li>
          <li>match your rep ID</li>
          <li>pass verification</li>
        </ul>
        <p><strong>No clean = no commission.</strong></p>
      </div>

      <!-- Section 4 -->
      <div class="policy-section">
        <h2>4. Verification Rules</h2>
        <p>A customer is only classed as verified if:</p>
        <ul>
          <li>They were signed within your assigned territory</li>
          <li>Their details were logged correctly in the Swash app</li>
          <li>They passed serviceability checks</li>
          <li>They completed—and paid for—their first clean</li>
          <li>No cancellation or refund occurred</li>
          <li>No duplicate or fraudulent sign-up exists</li>
        </ul>
        <p>Only verified customers qualify for the £15 → £8 → £8 commission.</p>
      </div>

      <!-- Section 5 -->
      <div class="policy-section">
        <h2>5. Conduct & Customer Interaction</h2>
        <p>While you choose how to work, you must uphold Swash standards when representing the brand:</p>
        <ul>
          <li>Always wear the provided uniform</li>
          <li>Be polite, honest, and respectful</li>
          <li>Do not use aggressive, misleading, or high-pressure tactics</li>
          <li>Respect “No Cold Calling” signs</li>
          <li>Leave immediately if asked</li>
          <li>Never enter customer homes</li>
          <li>Never take card details, bank details, or personal info manually</li>
          <li>All sign-ups must go through the Swash system (no paper forms unless authorised)</li>
        </ul>
        <p>Any customer complaint related to your conduct may lead to loss of territory or termination of your contract.</p>
      </div>

      <!-- Section 6 -->
      <div class="policy-section">
        <h2>6. Data Protection & Confidentiality</h2>
        <p>As a representative of Swash, you must:</p>
        <ul>
          <li>Only collect data through approved systems</li>
          <li>Never store customer data on personal devices</li>
          <li>Never share, export, or screenshot customer data</li>
          <li>Protect your login credentials</li>
          <li>Report data breaches immediately</li>
        </ul>
        <p>All customer data remains the exclusive property of Swash Cleaning Ltd.</p>
      </div>

      <!-- Section 7 -->
      <div class="policy-section">
        <h2>7. Uniform & Appearance</h2>
        <p>Swash provides:</p>
        <ul>
          <li>Polo shirt</li>
          <li>Jacket</li>
          <li>Umbrella</li>
        </ul>
        <p>Contractors provide:</p>
        <ul>
          <li>Black trousers</li>
          <li>Suitable footwear</li>
        </ul>
        <p>Uniform must be clean, presentable, and worn when representing Swash.</p>
      </div>

      <!-- Section 8 -->
      <div class="policy-section">
        <h2>8. Health & Safety & Lone Working</h2>
        <p>To protect your safety while working independently:</p>
        <ul>
          <li>Keep your phone charged</li>
          <li>Enable GPS tracking while working</li>
          <li>Work in safe, appropriate areas</li>
          <li>Do not canvass after dark in unsafe locations</li>
          <li>Check in with management at start and finish of shift (for safety only, not time control)</li>
          <li>Report incidents immediately</li>
          <li>Never enter customer homes</li>
        </ul>
        <p>You are responsible for your own general safety as a self-employed contractor.</p>
      </div>

      <!-- Section 9 -->
      <div class="policy-section">
        <h2>9. Equal Opportunities</h2>
        <p>Swash Cleaning Ltd is committed to fair treatment of all contractors and customers.</p>
        <p>Harassment, discrimination, or abusive conduct will not be tolerated.</p>
      </div>

      <!-- Section 10 -->
      <div class="policy-section">
        <h2>10. Non-Compete & Post-Contract Conduct</h2>
        <p>For 6 months after your contract ends, you must not:</p>
        <ul>
          <li>Offer or provide cleaning services to Swash customers you originally signed</li>
          <li>Divert customers to a competitor</li>
          <li>Operate or assist a competing cleaning business within 15 miles of your previous assigned territory</li>
        </ul>
      </div>

      <!-- Section 11 -->
      <div class="policy-section">
        <h2>11. Social Media & Brand Representation</h2>
        <p>Do not:</p>
        <ul>
          <li>Post customer information online</li>
          <li>Use the Swash logo or brand without permission</li>
          <li>Publish content that may damage the Swash reputation</li>
        </ul>
      </div>

      <!-- Section 12 -->
      <div class="policy-section">
        <h2>12. Technology & App Usage</h2>
        <p>You must:</p>
        <ul>
          <li>Use the Swash app for all sales, tracking, and verification</li>
          <li>Allow app GPS tracking during field activity</li>
          <li>Keep all data within official systems</li>
          <li>Report technical issues immediately</li>
        </ul>
        <p>The app is the official record of all sales and verification.</p>
      </div>

      <!-- Section 13 -->
      <div class="policy-section">
        <h2>13. Vehicle & Driving Requirements</h2>
        <p>If using a vehicle while performing sales activity:</p>
        <ul>
          <li>You must hold a full UK driving licence</li>
          <li>Your insurance must permit business use</li>
          <li>Your vehicle must be road legal with MOT</li>
        </ul>
        <p>Swash does not reimburse travel or vehicle expenses.</p>
      </div>

      <!-- Section 14 -->
      <div class="policy-section">
        <h2>14. Policy Acknowledgement</h2>
        <p>Contractor Name: ___________________________<br>
        Signature: _________________________________<br>
        Date: ______________________________________</p>
        <p>Director (Swash Cleaning Ltd): __________________________________</p>
      </div>

      <!-- Section 15 -->
      <div class="policy-section">
        <h2>15. Technology & App Usage Policy</h2>
        <ul>
          <li>Use only company-approved apps for signups, mileage, and reporting.</li>
          <li>All customer and sales data remain property of Swash Cleaning Ltd.</li>
          <li>Personal use of company devices or apps during work hours is not permitted.</li>
          <li>Tracking and GPS tools must remain active while working.</li>
          <li>Full details are provided in the standalone Technology & App Usage Policy document.</li>
        </ul>
      </div>

      <!-- Section 16 -->
      <div class="policy-section">
        <h2>16. Driving Licence & Vehicle Declaration</h2>
        <p>All employees using personal vehicles for business must:</p>
        <ul>
          <li>Hold a full UK driving licence.</li>
          <li>Maintain valid MOT and insurance for business use.</li>
          <li>Submit the Driving Licence & Vehicle Declaration Form.</li>
        </ul>
      </div>

      <!-- Section 17 -->
      <div class="policy-section">
        <h2>17. Policy Acknowledgement</h2>
        <div class="highlight-box">
          <p style="margin: 0;"><strong>I confirm I have received, read, and understood the Swash Cleaning Ltd Field Sales Team Policy Handbook and agree to comply with all company policies.</strong></p>
        </div>
        
        <form id="policyAcknowledgementForm" style="margin-top: 30px;">
          <!-- Employee Name -->
          <div style="margin-bottom: 24px;">
            <label for="employeeName" style="display: block; font-weight: 600; color: #1e293b; margin-bottom: 8px;">Contractor Name:</label>
            <input 
              type="text" 
              id="employeeName" 
              name="employeeName" 
              required
              placeholder="Enter your full name"
              style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 1rem; box-sizing: border-box; font-family: Arial, sans-serif;"
            >
          </div>

          <!-- Employee Signature -->
          <div style="margin-bottom: 24px;">
            <label for="signatureCanvas" style="display: block; font-weight: 600; color: #1e293b; margin-bottom: 8px;">Contractor Signature:</label>
            <div style="border: 2px solid #e5e7eb; border-radius: 6px; background: #f8fafc; padding: 8px; max-width: 600px;">
              <canvas 
                id="signatureCanvas" 
                width="600" 
                height="200"
                style="display: block; cursor: crosshair; background: white; border-radius: 4px; touch-action: none; width: 100%; height: auto;"
              ></canvas>
            </div>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <button 
                type="button" 
                id="clearSignature" 
                class="btn btn-secondary"
                style="flex: 1;"
              >Clear Signature</button>
              <button 
                type="button" 
                id="undoSignature" 
                class="btn btn-secondary"
                style="flex: 1;"
              >Undo</button>
            </div>
            <p style="font-size: 0.85rem; color: #64748b; margin-top: 8px;">Click and drag to sign above</p>
          </div>

          <!-- Employee Date (Auto-filled) -->
          <div style="margin-bottom: 24px;">
            <label for="employeeDate" style="display: block; font-weight: 600; color: #1e293b; margin-bottom: 8px;">Date:</label>
            <input 
              type="text" 
              id="employeeDate" 
              name="employeeDate" 
              readonly
              style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 1rem; box-sizing: border-box; background: #f8fafc; color: #64748b;"
            >
          </div>

          <!-- Director Section -->
          <div style="margin-top: 40px; padding-top: 24px; border-top: 2px solid #e5e7eb;">
            <p style="font-weight: 600; color: #1e293b; margin-bottom: 20px;">For Swash Cleaning Ltd:</p>
            
            <div style="margin-bottom: 24px;">
              <p style="margin: 0 0 8px 0; font-weight: 600; color: #1e293b;">Christopher Wessell (Director)</p>
            </div>

            <div style="margin-bottom: 24px;">
              <label for="directorSignature" style="display: block; font-weight: 600; color: #1e293b; margin-bottom: 8px;">Signature:</label>
              <div style="border: 2px solid #e5e7eb; border-radius: 6px; background: #f8fafc; padding: 8px; max-width: 600px;">
                <canvas 
                  id="directorSignature" 
                  width="600" 
                  height="200"
                  style="display: block; cursor: crosshair; background: white; border-radius: 4px; touch-action: none; width: 100%; height: auto;"
                ></canvas>
              </div>
              <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button 
                  type="button" 
                  id="clearDirectorSignature" 
                  class="btn btn-secondary"
                  style="flex: 1;"
                >Clear Signature</button>
                <button 
                  type="button" 
                  id="undoDirectorSignature" 
                  class="btn btn-secondary"
                  style="flex: 1;"
                >Undo</button>
              </div>
              <p style="font-size: 0.85rem; color: #64748b; margin-top: 8px;">Click and drag to sign above</p>
            </div>

            <div style="margin-bottom: 24px;">
              <label for="directorDate" style="display: block; font-weight: 600; color: #1e293b; margin-bottom: 8px;">Date:</label>
              <input 
                type="text" 
                id="directorDate" 
                name="directorDate" 
                readonly
                style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 1rem; box-sizing: border-box; background: #f8fafc; color: #64748b;"
              >
            </div>

            <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 16px; border-radius: 4px; margin-top: 16px;">
              <p style="margin: 0; font-size: 0.95rem; color: #92400e;">
                <strong>ℹ️ Note:</strong> The director signature and date will be added by Swash management once you submit your acknowledgement. Your submission will be saved automatically.
              </p>
            </div>
          </div>

          <!-- Submit Button (placeholder for now) -->
          <div style="margin-top: 32px; display: flex; gap: 12px;">
            <button 
              type="submit" 
              class="btn btn-primary"
              style="flex: 1; padding: 12px 24px; font-size: 1rem;"
            >Submit Acknowledgement</button>
            <button 
              type="reset" 
              class="btn btn-secondary"
              style="flex: 1; padding: 12px 24px; font-size: 1rem;"
            >Reset Form</button>
          </div>
        </form>
      </div>

      <!-- Footer -->
      <div class="footer-text">
        <p>Swash Cleaning Ltd | Field Sales Team Policy Handbook | Version 1.8 – Commission-Only Contractors | © 2025<br>
        contact@swashcleaning.co.uk | 03300 436 345</p>
      </div>
    </div>
  </main>

  <script type="module" src="../auth-check.js"></script>

  <script type="module">
    import { auth, db } from '../public/firebase-init.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { doc, getDoc, updateDoc, addDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    
    let currentUser = null;
    let isAdmin = false;
    let savedAcknowledgment = null;
    
    // Wait for auth
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        // Check role
        try {
          const userDoc = await getDoc(doc(db, 'users', user.uid));
          if (userDoc.exists()) {
            const userData = userDoc.data();
            isAdmin = userData.role === 'admin';
            
            if (userData.policyAcknowledgedAt) {
              savedAcknowledgment = userData;
              
              // Already acknowledged - show message and restore signature
              const banner = document.createElement('div');
              banner.style.cssText = 'background: #d1fae5; border: 2px solid #10b981; padding: 16px; border-radius: 8px; margin: 20px 0; text-align: center;';
              banner.innerHTML = `
                <p style="margin: 0; color: #065f46; font-weight: 600;">
                  ✓ You acknowledged this policy handbook on ${new Date(userData.policyAcknowledgedAt).toLocaleDateString('en-GB')}
                </p>
              `;
              document.querySelector('#policyAcknowledgementForm').insertAdjacentElement('beforebegin', banner);
              
              // Restore name and signature
              if (userData.policyAcknowledgedName) {
                document.getElementById('employeeName').value = userData.policyAcknowledgedName;
              }
              if (userData.policyAcknowledgedSignature) {
                renderSavedSignature('signatureCanvas', userData.policyAcknowledgedSignature);
              }
              
              // Disable employee inputs (name, signature, buttons)
              document.getElementById('employeeName').readOnly = true;
              document.getElementById('signatureCanvas').style.pointerEvents = 'none';
              document.getElementById('clearSignature').disabled = true;
              document.getElementById('undoSignature').disabled = true;
              document.querySelector('button[type="submit"]').disabled = true;
              document.querySelector('button[type="reset"]').disabled = true;
            }
            
            // Disable director signature for non-admins ALWAYS
            if (!isAdmin) {
              document.getElementById('directorSignature').style.pointerEvents = 'none';
              document.getElementById('clearDirectorSignature').disabled = true;
              document.getElementById('undoDirectorSignature').disabled = true;
            }
          }
        } catch(err) {
          console.error('Failed to check policy acknowledgment:', err);
        }
      }
    });
    
    function renderSavedSignature(canvasId, dataUrl) {
      try {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.onload = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        };
        img.src = dataUrl;
      } catch(err) {
        console.error('Failed to render signature:', err);
      }
    }
    
    // Signature Canvas Handler
    class SignatureCanvas {
      constructor(canvasId, clearBtnId, undoBtnId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d');
        this.isDrawing = false;
        this.paths = [];
        this.currentPath = [];

        // Set canvas size responsively
        this.resizeCanvas();
        
        // Event listeners
        this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
        this.canvas.addEventListener('mousemove', (e) => this.draw(e));
        this.canvas.addEventListener('mouseup', () => this.stopDrawing());
        this.canvas.addEventListener('mouseout', () => this.stopDrawing());

        // Touch events for mobile
        this.canvas.addEventListener('touchstart', (e) => this.startDrawing(e));
        this.canvas.addEventListener('touchmove', (e) => this.draw(e));
        this.canvas.addEventListener('touchend', () => this.stopDrawing());

        // Clear and Undo buttons
        document.getElementById(clearBtnId).addEventListener('click', () => this.clearCanvas());
        document.getElementById(undoBtnId).addEventListener('click', () => this.undoPath());
      }

      resizeCanvas() {
        const rect = this.canvas.getBoundingClientRect();
        this.canvas.width = rect.width;
        this.canvas.height = rect.height;
        this.redrawCanvas();
      }

      startDrawing(e) {
        this.isDrawing = true;
        this.currentPath = [];
        const pos = this.getPosition(e);
        this.currentPath.push(pos);
        this.ctx.beginPath();
        this.ctx.moveTo(pos.x, pos.y);
      }

      draw(e) {
        if (!this.isDrawing) return;
        
        const pos = this.getPosition(e);
        this.currentPath.push(pos);
        
        this.ctx.lineTo(pos.x, pos.y);
        this.ctx.lineWidth = 2;
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
        this.ctx.strokeStyle = '#0078d7';
        this.ctx.stroke();
      }

      stopDrawing() {
        if (!this.isDrawing) return;
        this.isDrawing = false;
        this.ctx.closePath();
        if (this.currentPath.length > 0) {
          this.paths.push(this.currentPath);
        }
      }

      getPosition(e) {
        const rect = this.canvas.getBoundingClientRect();
        if (e.touches) {
          return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top
          };
        }
        return {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };
      }

      clearCanvas() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.paths = [];
        this.currentPath = [];
      }

      undoPath() {
        this.paths.pop();
        this.redrawCanvas();
      }

      redrawCanvas() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.paths.forEach(path => {
          this.ctx.beginPath();
          this.ctx.moveTo(path[0].x, path[0].y);
          for (let i = 1; i < path.length; i++) {
            this.ctx.lineTo(path[i].x, path[i].y);
          }
          this.ctx.lineWidth = 2;
          this.ctx.lineCap = 'round';
          this.ctx.lineJoin = 'round';
          this.ctx.strokeStyle = '#0078d7';
          this.ctx.stroke();
          this.ctx.closePath();
        });
      }

      getSignatureData() {
        return this.canvas.toDataURL('image/png');
      }

      hasSignature() {
        return this.paths.length > 0;
      }
    }

    // Initialize signature canvases
    const employeeSignature = new SignatureCanvas('signatureCanvas', 'clearSignature', 'undoSignature');
    const directorSignature = new SignatureCanvas('directorSignature', 'clearDirectorSignature', 'undoDirectorSignature');

    // Auto-fill dates
    function formatDate(date) {
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    const today = new Date();
    document.getElementById('employeeDate').value = formatDate(today);
    document.getElementById('directorDate').value = formatDate(today);

    // Form submission handler
    document.getElementById('policyAcknowledgementForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      // Validation
      const employeeName = document.getElementById('employeeName').value.trim();
      if (!employeeName) {
        alert('Please enter your name');
        return;
      }

      if (!employeeSignature.hasSignature()) {
        alert('Please sign in the employee signature box');
        return;
      }

      // Prepare submission data
      const formData = {
        employeeName: employeeName,
        employeeSignature: employeeSignature.getSignatureData(),
        employeeDate: document.getElementById('employeeDate').value,
        directorSignature: directorSignature.hasSignature() ? directorSignature.getSignatureData() : null,
        directorDate: document.getElementById('directorDate').value,
        submittedAt: new Date().toISOString(),
        acknowledged: true
      };

      console.log('Policy acknowledgement form ready for submission:', formData);
      
      // Save to Firebase
      if (!currentUser) {
        alert('You must be signed in to acknowledge the policy.');
        return;
      }
      
      try {
        await updateDoc(doc(db, 'users', currentUser.uid), {
          policyAcknowledgedAt: new Date().toISOString(),
          policyAcknowledgedName: employeeName,
          policyAcknowledgedSignature: formData.employeeSignature
        });
        
        // Create admin todo for policy acknowledgment review
        try {
          const adminQuery = query(collection(db, 'users'), where('role', '==', 'admin'));
          const adminSnap = await getDocs(adminQuery);
          const adminIds = adminSnap.docs.map(doc => doc.id);
          if (adminIds.length > 0) {
            await addDoc(collection(db, 'todos'), {
              title: `Review ${employeeName}'s Policy Acknowledgment`,
              description: `${employeeName} has acknowledged the Policy Handbook. Please review and countersign if required.`,
              assignedRepIds: adminIds,
              completed: false,
              deleted: false,
              createdAt: new Date().toISOString(),
              createdBy: currentUser.uid
            });
          }
        } catch (todoErr) { console.warn('Failed to create admin todo', todoErr); }
        
        alert('✓ Policy acknowledgement submitted successfully. Your response has been saved. Thank you!');
        
        // Disable form after submission
        document.getElementById('policyAcknowledgementForm').style.opacity = '0.6';
        document.getElementById('policyAcknowledgementForm').style.pointerEvents = 'none';
        
        // Reload page to show acknowledgment banner
        setTimeout(() => window.location.reload(), 1500);
      } catch(err) {
        console.error('Failed to save policy acknowledgment:', err);
        alert('Failed to save your acknowledgment. Please try again.');
      }
    });

    // Handle window resize for responsive canvas
    window.addEventListener('resize', () => {
      employeeSignature.resizeCanvas();
      directorSignature.resizeCanvas();
    });
  </script>

