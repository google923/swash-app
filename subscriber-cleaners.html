<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0078d7" />
  <title>Manage Cleaners - Swash Subscriber</title>
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./assets/favicon-192.png" type="image/png" />
  <link rel="stylesheet" href="./style.css" />
  <style>
    .admin-only, .rep-only, .admin-rep { display: none !important; }
    .subscriber-only { display: block !important; }
    
    .cleaners-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .cleaner-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s;
    }
    
    .cleaner-card:hover {
      border-color: #0078d7;
      box-shadow: 0 4px 12px rgba(0,120,215,0.15);
    }
    
    .cleaner-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 16px;
    }
    
    .cleaner-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: #1e293b;
    }
    
    .cleaner-badge {
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .badge-active {
      background: #dcfce7;
      color: #166534;
    }
    
    .badge-inactive {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .cleaner-info {
      margin-bottom: 16px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    
    .info-label {
      color: #64748b;
      font-size: 0.9rem;
    }
    
    .info-value {
      color: #1e293b;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .cleaner-actions {
      display: flex;
      gap: 8px;
    }
    
    .add-cleaner-card {
      border: 2px dashed #cbd5e1;
      background: #f8fafc;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      min-height: 200px;
    }
    
    .add-cleaner-card:hover {
      border-color: #0078d7;
      background: #f0f7ff;
    }
    
    .pricing-banner {
      background: linear-gradient(135deg, #0078d7 0%, #005a9e 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .pricing-info h3 {
      margin: 0 0 8px 0;
      font-size: 1.3rem;
    }
    
    .pricing-info p {
      margin: 0;
      opacity: 0.9;
    }
    
    .pricing-total {
      text-align: right;
    }
    
    .pricing-total .amount {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .pricing-total .period {
      opacity: 0.9;
      font-size: 0.9rem;
    }
    
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 1.3rem;
      color: #1e293b;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.8rem;
      color: #64748b;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
    }
    
    .modal-close:hover {
      background: #f1f5f9;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      color: #334155;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #0078d7;
      box-shadow: 0 0 0 3px rgba(0,120,215,0.1);
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="header-left">
      <img class="header-logo" src="./assets/swash-logo.png" alt="Swash logo" />
      <h1 style="margin: 0 0 0 12px; font-size: 1.2rem;">üë∑ Manage Cleaners</h1>
    </div>
    <div class="header-actions">
      <button id="logoutBtn" class="btn btn-secondary" type="button">Sign out</button>
      <div class="menu-box">
        <button id="menuBtn" class="btn btn-secondary" aria-haspopup="true" aria-expanded="false">Menu</button>
        <nav id="menuDropdown" class="dropdown">
          <div class="dropdown-title">Navigation</div>
          <a href="/subscriber-dashboard.html" class="subscriber-only">üè† Dashboard</a>
          <a href="/subscriber-quotes.html" class="subscriber-only">üìã Quotes</a>
          <a href="/subscriber-customers.html" class="subscriber-only">üë• Customers</a>
          <a href="/rep/scheduler.html" class="subscriber-only">üìÖ Schedule</a>
          <a href="/subscriber-cleaners.html" class="subscriber-only">üë∑ Cleaners</a>
          <a href="/subscriber-territories.html" class="subscriber-only">üó∫Ô∏è Territories</a>
          <a href="/subscriber-users.html" class="subscriber-only">üë§ Users</a>
        </nav>
      </div>
    </div>
  </header>

  <section id="authOverlay" class="auth-overlay" aria-live="polite">
    <div class="auth-card">
      <h2>Checking authentication...</h2>
      <p class="text-muted">Please wait while we verify your account.</p>
    </div>
  </section>

  <main id="cleanersContent" class="page" style="display:none;">
    <section class="card">
      <header class="card-header">
        <div class="card-header-main">
          <h2>Your Cleaners</h2>
          <p class="text-muted">Manage your team and subscription billing</p>
        </div>
        <div class="card-header-actions">
          <button id="addCleanerBtn" class="btn btn-primary">+ Add Cleaner</button>
        </div>
      </header>

      <div style="padding:20px;">
        <div class="pricing-banner">
          <div class="pricing-info">
            <h3>üí° Pricing Information</h3>
            <p>Base subscription: ¬£15/month (includes 1 cleaner)</p>
            <p>Additional cleaners: ¬£10/month each</p>
          </div>
          <div class="pricing-total">
            <div class="amount" id="totalCost">¬£15.00</div>
            <div class="period">per month</div>
          </div>
        </div>

        <div class="cleaners-grid" id="cleanersGrid">
          <div style="text-align:center;padding:40px;color:#64748b;grid-column:1/-1;">
            Loading cleaners...
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Add/Edit Cleaner Modal -->
  <div id="cleanerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Add Cleaner</h3>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      
      <form id="cleanerForm">
        <div class="form-group">
          <label for="cleanerName">Cleaner Name *</label>
          <input type="text" id="cleanerName" required placeholder="e.g., John Smith" />
        </div>
        
        <div class="form-group">
          <label for="cleanerEmail">Email</label>
          <input type="email" id="cleanerEmail" placeholder="cleaner@example.com" />
        </div>
        
        <div class="form-group">
          <label for="cleanerPhone">Phone</label>
          <input type="tel" id="cleanerPhone" placeholder="07XXX XXXXXX" />
        </div>
        
        <div class="form-group">
          <label for="cleanerStatus">Status *</label>
          <select id="cleanerStatus" required>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
          <button type="submit" class="btn btn-primary" id="saveCleanerBtn">Save Cleaner</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { updateBillingSeatDelta } from './billing.js';
    import {
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import {
      doc,
      getDoc,
      collection,
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc,
      serverTimestamp,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    let subscriberId = null;
    let editingCleanerId = null;
    let cleaners = [];

    const authOverlay = document.getElementById('authOverlay');
    const cleanersContent = document.getElementById('cleanersContent');
    const cleanersGrid = document.getElementById('cleanersGrid');
    const totalCostEl = document.getElementById('totalCost');
    const logoutBtn = document.getElementById('logoutBtn');
    const menuBtn = document.getElementById('menuBtn');
    const menuDropdown = document.getElementById('menuDropdown');
    const addCleanerBtn = document.getElementById('addCleanerBtn');
    const cleanerModal = document.getElementById('cleanerModal');
    const modalClose = document.getElementById('modalClose');
    const cancelBtn = document.getElementById('cancelBtn');
    const cleanerForm = document.getElementById('cleanerForm');
    const modalTitle = document.getElementById('modalTitle');

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = './subscriber-login.html';
        return;
      }

      try {
        const urlParams = new URLSearchParams(window.location.search);
        const viewingUid = urlParams.get('uid');

        const currentUserDoc = await getDoc(doc(db, 'users', user.uid));
        if (!currentUserDoc.exists()) throw new Error('User not found');

        const currentUserData = currentUserDoc.data();

        if (viewingUid && currentUserData.role === 'admin') {
          subscriberId = viewingUid;
        } else {
          subscriberId = user.uid;
          if (currentUserData.role !== 'subscriber') {
            throw new Error('Access denied');
          }
          if (!currentUserData.billingCompleted) {
            window.location.href = './subscriber-billing.html';
            return;
          }
        }

        authOverlay.style.display = 'none';
        cleanersContent.style.display = 'block';

        await loadCleaners();

      } catch (error) {
        console.error('Auth error:', error);
        alert(error.message);
        await signOut(auth);
        window.location.href = './subscriber-login.html';
      }
    });

    async function loadCleaners() {
      try {
        const cleanersRef = collection(db, `subscribers/${subscriberId}/cleaners`);
        const snapshot = await getDocs(cleanersRef);

        cleaners = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        renderCleaners();
        updateTotalCost();

      } catch (error) {
        console.error('Error loading cleaners:', error);
        cleanersGrid.innerHTML = '<div style="text-align:center;padding:40px;color:#dc2626;grid-column:1/-1;">Failed to load cleaners</div>';
      }
    }

    function renderCleaners() {
      if (cleaners.length === 0) {
        cleanersGrid.innerHTML = `
          <div style="text-align:center;padding:60px 20px;color:#64748b;grid-column:1/-1;">
            <div style="font-size:48px;margin-bottom:16px;">üë∑</div>
            <h3 style="margin:0 0 8px 0;color:#1e293b;">No Cleaners Yet</h3>
            <p style="margin:0 0 20px 0;">Add your first cleaner to get started</p>
            <button class="btn btn-primary" onclick="document.getElementById('addCleanerBtn').click()">+ Add Your First Cleaner</button>
          </div>
        `;
        return;
      }

      cleanersGrid.innerHTML = cleaners.map(cleaner => `
        <div class="cleaner-card">
          <div class="cleaner-header">
            <div class="cleaner-name">${escapeHtml(cleaner.name || 'Unnamed')}</div>
            <span class="cleaner-badge ${cleaner.status === 'active' ? 'badge-active' : 'badge-inactive'}">
              ${cleaner.status === 'active' ? 'Active' : 'Inactive'}
            </span>
          </div>
          
          <div class="cleaner-info">
            ${cleaner.email ? `
              <div class="info-row">
                <span class="info-label">üìß Email</span>
                <span class="info-value">${escapeHtml(cleaner.email)}</span>
              </div>
            ` : ''}
            ${cleaner.phone ? `
              <div class="info-row">
                <span class="info-label">üì± Phone</span>
                <span class="info-value">${escapeHtml(cleaner.phone)}</span>
              </div>
            ` : ''}
            <div class="info-row">
              <span class="info-label">üìÖ Added</span>
              <span class="info-value">${formatDate(cleaner.createdAt)}</span>
            </div>
          </div>
          
          <div class="cleaner-actions">
            <button class="btn btn-sm btn-secondary" onclick="window.editCleaner('${cleaner.id}')">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="window.deleteCleaner('${cleaner.id}', '${escapeHtml(cleaner.name || 'this cleaner')}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function updateTotalCost() {
      const baseCost = 15; // ¬£15 includes 1 cleaner
      const activeCleaners = cleaners.filter(c => c.status === 'active').length;
      const extraCleaners = Math.max(0, activeCleaners - 1);
      const totalCost = baseCost + (extraCleaners * 10);
      
      totalCostEl.textContent = `¬£${totalCost.toFixed(2)}`;
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      try {
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('en-GB');
      } catch (e) {
        return 'N/A';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Modal controls
    addCleanerBtn.addEventListener('click', () => {
      editingCleanerId = null;
      modalTitle.textContent = 'Add Cleaner';
      cleanerForm.reset();
      document.getElementById('cleanerStatus').value = 'active';
      cleanerModal.classList.add('show');
    });

    function closeModal() {
      cleanerModal.classList.remove('show');
      cleanerForm.reset();
      editingCleanerId = null;
    }

    modalClose.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);

    cleanerModal.addEventListener('click', (e) => {
      if (e.target === cleanerModal) closeModal();
    });

    // Edit cleaner
    window.editCleaner = async (cleanerId) => {
      const cleaner = cleaners.find(c => c.id === cleanerId);
      if (!cleaner) return;

      editingCleanerId = cleanerId;
      modalTitle.textContent = 'Edit Cleaner';
      
      document.getElementById('cleanerName').value = cleaner.name || '';
      document.getElementById('cleanerEmail').value = cleaner.email || '';
      document.getElementById('cleanerPhone').value = cleaner.phone || '';
      document.getElementById('cleanerStatus').value = cleaner.status || 'active';
      
      cleanerModal.classList.add('show');
    };

    // Delete cleaner
    window.deleteCleaner = async (cleanerId, cleanerName) => {
      if (!confirm(`Are you sure you want to delete ${cleanerName}?\n\nNote: This will reduce your monthly subscription by ¬£10 if they are not one of your first cleaner included in the base price.`)) {
        return;
      }

      try {
        // Compute seat delta before delete
        const beforeActive = cleaners.filter(c => c.status === 'active').length;
        const deleted = cleaners.find(c => c.id === cleanerId);
        const wasActive = deleted && deleted.status === 'active';

        await deleteDoc(doc(db, `subscribers/${subscriberId}/cleaners`, cleanerId));

        // Record billing seat delta after successful delete
        if (wasActive) {
          const afterActive = Math.max(0, beforeActive - 1);
          const beforeExtra = Math.max(0, beforeActive - 1);
          const afterExtra = Math.max(0, afterActive - 1);
          const deltaSeats = afterExtra - beforeExtra; // likely -1
          if (deltaSeats !== 0) {
            await updateBillingSeatDelta(subscriberId, deltaSeats, 'cleaner-deleted', { cleanerId, cleanerName });
          }
        }

        alert('Cleaner deleted successfully.');
        
        await loadCleaners();
      } catch (error) {
        console.error('Error deleting cleaner:', error);
        alert('Failed to delete cleaner: ' + error.message);
      }
    };

    // Save cleaner (add or update)
    cleanerForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const cleanerData = {
        name: document.getElementById('cleanerName').value.trim(),
        email: document.getElementById('cleanerEmail').value.trim() || null,
        phone: document.getElementById('cleanerPhone').value.trim() || null,
        status: document.getElementById('cleanerStatus').value,
        updatedAt: serverTimestamp()
      };

      try {
        if (editingCleanerId) {
          // Update existing cleaner (track status change for billing)
          const existing = cleaners.find(c => c.id === editingCleanerId) || {};
          const beforeActive = cleaners.filter(c => c.status === 'active').length;
          const oldActive = existing.status === 'active';
          const newActive = cleanerData.status === 'active';

          await updateDoc(doc(db, `subscribers/${subscriberId}/cleaners`, editingCleanerId), cleanerData);

          // Compute seat delta if active flag changed
          let deltaSeats = 0;
          if (oldActive !== newActive) {
            const afterActive = beforeActive + (newActive ? 1 : -1);
            const beforeExtra = Math.max(0, beforeActive - 1);
            const afterExtra = Math.max(0, afterActive - 1);
            deltaSeats = afterExtra - beforeExtra; // -1, 0, or +1
          }
          if (deltaSeats !== 0) {
            await updateBillingSeatDelta(subscriberId, deltaSeats, 'cleaner-status-changed', { cleanerId: editingCleanerId });
          }
          alert('Cleaner updated successfully!');
        } else {
          // Add new cleaner (consider status for billing)
          const beforeActive = cleaners.filter(c => c.status === 'active').length;
          const newActive = cleanerData.status === 'active';
          cleanerData.createdAt = serverTimestamp();
          await addDoc(collection(db, `subscribers/${subscriberId}/cleaners`), cleanerData);

          // Compute seat delta
          if (newActive) {
            const afterActive = beforeActive + 1;
            const beforeExtra = Math.max(0, beforeActive - 1);
            const afterExtra = Math.max(0, afterActive - 1);
            const deltaSeats = afterExtra - beforeExtra; // likely +1 when crossing >1
            if (deltaSeats !== 0) {
              await updateBillingSeatDelta(subscriberId, deltaSeats, 'cleaner-added');
            }
          }
          alert('Cleaner added successfully!');
        }

        closeModal();
        await loadCleaners();

      } catch (error) {
        console.error('Error saving cleaner:', error);
        alert('Failed to save cleaner: ' + error.message);
      }
    });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = './subscriber-login.html';
    });

    // Menu
    menuBtn.addEventListener('click', () => {
      menuDropdown.classList.toggle('show');
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.menu-box')) {
        menuDropdown.classList.remove('show');
      }
    });
  </script>

</body>
</html>
